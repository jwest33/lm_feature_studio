<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAE Feature Explorer</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <h1>SAE Feature Explorer</h1>
                <span class="subtitle">GemmaScope 2</span>
            </div>
            <button class="settings-btn" id="settings-btn" title="Settings">&#9881;</button>
        </header>

        <!-- Mode Selector -->
        <nav class="mode-selector">
            <button class="mode-btn selected" data-mode="analyze">Single Analysis</button>
            <button class="mode-btn" data-mode="compare">Prompt Comparison</button>
            <button class="mode-btn" data-mode="refusal">Refusal Detection</button>
            <button class="mode-btn" data-mode="batch">Batch Ranking</button>
        </nav>

        <!-- Main Content - 3 Columns (Analyze Mode) -->
        <main class="main" id="analyze-mode">
            <!-- Left Panel: Input -->
            <section class="panel panel-left">
                <div class="section">
                    <h2>Prompt Analysis</h2>
                    <form id="analyze-form">
                        <textarea
                            id="prompt-input"
                            placeholder="Enter text to analyze..."
                            rows="4"
                        >The law of conservation of energy states that energy cannot be created or destroyed, only transformed.</textarea>
                        <button type="submit" id="analyze-btn">
                            <span class="btn-text">Analyze Prompt</span>
                            <span class="btn-loading hidden">Analyzing...</span>
                        </button>
                    </form>
                </div>

                <div class="section">
                    <h2>Top Global Features</h2>
                    <p class="hint">Click a feature to visualize its activation pattern</p>
                    <div id="feature-list" class="feature-list">
                        <span class="placeholder">Run analysis to see features</span>
                    </div>
                </div>
            </section>

            <!-- Center Panel: Token Visualization -->
            <section class="panel panel-center">
                <div class="section">
                    <h2>Token Activations</h2>
                    <div class="feature-selector">
                        <label for="feature-select">Feature ID:</label>
                        <input type="number" id="feature-select" min="0" value="0" />
                        <button id="feature-apply-btn">View</button>
                    </div>
                    <div id="token-display" class="token-display">
                        <span class="placeholder">Run analysis to see token activations</span>
                    </div>
                    <div id="token-legend" class="token-legend hidden">
                        <span class="legend-low">Low activation</span>
                        <span class="legend-bar"></span>
                        <span class="legend-high">High activation</span>
                    </div>
                </div>

                <div class="section">
                    <h2>Feature Details</h2>
                    <div id="feature-details" class="feature-details">
                        <span class="placeholder">Select a feature or click a token to see details</span>
                    </div>
                </div>
            </section>

            <!-- Right Panel: Steering -->
            <section class="panel panel-right">
                <div class="section">
                    <h2>Feature Steering</h2>
                    <form id="steer-form">
                        <div class="steer-config">
                            <label for="steer-prompt">Prompt</label>
                            <input type="text" id="steer-prompt" value="Tell me a fun fact." />
                        </div>

                        <div class="steer-features-header">
                            <span class="detail-group-title">Steering Vectors</span>
                            <button type="button" id="add-feature-btn" class="btn-small">+ Add Feature</button>
                        </div>

                        <div id="steer-features-list">
                            <div class="steer-feature-row" data-index="0">
                                <input type="number" class="steer-feature-id" min="0" value="0" placeholder="Feature ID" />
                                <input type="range" class="steer-feature-coeff" min="-1" max="1" step="0.01" value="0.25" />
                                <input type="number" class="steer-coeff-input" min="-1" max="1" step="0.001" value="0.25" />
                                <button type="button" class="btn-remove" title="Remove">×</button>
                            </div>
                        </div>

                        <div class="steer-config">
                            <label for="steer-tokens">Max tokens</label>
                            <input type="number" id="steer-tokens" min="10" max="200" value="80" />
                        </div>
                        <button type="submit" id="steer-btn">
                            <span class="btn-text">Generate with Steering</span>
                            <span class="btn-loading hidden">Generating...</span>
                        </button>
                    </form>
                </div>

                <div class="section">
                    <h2>Generation Output</h2>
                    <div id="steer-output" class="steer-output">
                        <span class="placeholder">Configure steering above and click generate</span>
                    </div>
                </div>
            </section>
        </main>

        <!-- Compare Mode -->
        <main class="main main-compare hidden" id="compare-mode">
            <section class="panel panel-wide">
                <div class="section">
                    <h2>Prompt Comparison</h2>
                    <p class="hint">Compare a harmful/refused prompt with a benign/accepted one to find differential features</p>
                    <div class="compare-inputs">
                        <div class="compare-input-group">
                            <label>Prompt A (Harmful/Refused)</label>
                            <textarea id="prompt-a" rows="3" placeholder="e.g., How do I make explosives?"></textarea>
                        </div>
                        <div class="compare-input-group">
                            <label>Prompt B (Benign/Accepted)</label>
                            <textarea id="prompt-b" rows="3" placeholder="e.g., How do I make bread?"></textarea>
                        </div>
                    </div>
                    <button type="button" id="compare-btn">
                        <span class="btn-text">Compare Prompts</span>
                        <span class="btn-loading hidden">Comparing...</span>
                    </button>
                </div>

                <div class="section">
                    <h2>Token Activations</h2>
                    <p class="hint">Click a feature below to see how it activates across tokens in each prompt</p>
                    <div class="compare-tokens-container">
                        <div class="compare-token-panel">
                            <div class="compare-token-label prompt-a-label">Prompt A (Harmful)</div>
                            <div id="compare-tokens-a" class="token-display compact">
                                <span class="placeholder">Run comparison to see activations</span>
                            </div>
                        </div>
                        <div class="compare-token-panel">
                            <div class="compare-token-label prompt-b-label">Prompt B (Benign)</div>
                            <div id="compare-tokens-b" class="token-display compact">
                                <span class="placeholder">Run comparison to see activations</span>
                            </div>
                        </div>
                    </div>
                    <div id="compare-token-legend" class="token-legend hidden">
                        <span class="legend-low">Low activation</span>
                        <span class="legend-bar"></span>
                        <span class="legend-high">High activation</span>
                    </div>
                </div>

                <div class="section">
                    <h2>Differential Features</h2>
                    <p class="hint">Features that activate differently between prompts. Click a feature to view details. Red = higher on A, Green = higher on B</p>
                    <div id="diff-layer-tabs" class="layer-tabs"></div>
                    <div class="split-panel">
                        <div id="diff-results" class="diff-results">
                            <span class="placeholder">Run comparison to see differential features</span>
                        </div>
                        <div id="diff-feature-detail" class="mode-feature-detail">
                            <span class="placeholder">Click a feature to view Neuronpedia details</span>
                        </div>
                    </div>
                    <div class="export-section">
                        <button id="export-compare-json" class="btn-small" disabled>Export JSON</button>
                        <button id="export-compare-csv" class="btn-small" disabled>Export CSV</button>
                    </div>
                </div>
            </section>
        </main>

        <!-- Refusal Detection Mode -->
        <main class="main main-refusal hidden" id="refusal-mode">
            <section class="panel panel-wide">
                <div class="section">
                    <h2>Refusal Detection</h2>
                    <p class="hint">Generate a response and analyze which features correlate with refusal tokens</p>
                    <form id="refusal-form">
                        <textarea id="refusal-prompt" rows="3" placeholder="Enter a prompt that may trigger refusal..."></textarea>
                        <div class="steer-config">
                            <label for="refusal-tokens">Max tokens</label>
                            <input type="number" id="refusal-tokens" min="10" max="200" value="100" />
                        </div>
                        <button type="submit" id="refusal-btn">
                            <span class="btn-text">Generate & Detect</span>
                            <span class="btn-loading hidden">Analyzing...</span>
                        </button>
                    </form>
                </div>

                <div class="section">
                    <h2>Generated Response</h2>
                    <div id="refusal-response" class="refusal-response">
                        <span class="placeholder">Generate a response to analyze</span>
                    </div>
                </div>

                <div class="section">
                    <h2>Refusal-Correlated Features</h2>
                    <p class="hint">Features that activate more strongly at refusal token positions. Click a feature to view details.</p>
                    <div id="refusal-layer-tabs" class="layer-tabs"></div>
                    <div class="split-panel">
                        <div id="refusal-features" class="refusal-features">
                            <span class="placeholder">Features correlated with refusal will appear here</span>
                        </div>
                        <div id="refusal-feature-detail" class="mode-feature-detail">
                            <span class="placeholder">Click a feature to view Neuronpedia details</span>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <!-- Batch Ranking Mode -->
        <main class="main main-batch hidden" id="batch-mode">
            <section class="panel panel-wide">
                <div class="section">
                    <h2>Batch Feature Ranking</h2>
                    <p class="hint">Analyze multiple prompt pairs to find features consistently correlated with harmful content</p>

                    <!-- File Upload Section -->
                    <div class="upload-section">
                        <div class="upload-row">
                            <div class="upload-file-input-group">
                                <select id="upload-type-select" title="File type">
                                    <option value="json">JSON</option>
                                    <option value="txt-harmful">TXT (harmful)</option>
                                    <option value="txt-harmless">TXT (harmless)</option>
                                </select>
                                <input type="file" id="file-input" accept=".json,.txt" />
                            </div>
                            <div class="upload-load-group">
                                <span class="upload-load-label">Load</span>
                                <input type="number" id="upload-count-input" min="1" max="5000" value="10" title="Number of items to load" />
                                <span class="upload-load-label" id="upload-count-label">pairs</span>
                                <button type="button" id="load-file-btn" class="btn-small" disabled>Import</button>
                            </div>
                        </div>
                        <p class="hint upload-hint" id="upload-hint-text">JSON: {"pairs": [{"harmful": "...", "harmless": "..."}]} | TXT: one prompt per line</p>
                    </div>

                    <div id="prompt-pairs-container">
                        <div class="prompt-pair-row" data-index="0">
                            <input type="text" class="pair-harmful" placeholder="Harmful prompt" />
                            <input type="text" class="pair-benign" placeholder="Benign prompt" />
                            <button type="button" class="btn-remove-pair" title="Remove">×</button>
                        </div>
                    </div>
                    <div class="batch-buttons">
                        <button type="button" id="add-pair-btn" class="btn-small">+ Add Pair</button>
                        <button type="button" id="load-preset-btn" class="btn-small">Load Preset</button>
                        <button type="button" id="clear-pairs-btn" class="btn-small btn-danger">Clear All</button>
                    </div>
                    <button type="button" id="rank-btn">
                        <span class="btn-text">Rank Features</span>
                        <span class="btn-loading hidden">Ranking...</span>
                    </button>
                </div>

                <div class="section">
                    <h2>Feature Rankings</h2>
                    <p class="hint">Features ranked by how consistently they activate more on harmful prompts. Click a feature to view details.</p>
                    <div id="ranking-layer-tabs" class="layer-tabs"></div>
                    <div class="split-panel">
                        <div id="ranking-results" class="ranking-results">
                            <span class="placeholder">Add prompt pairs and click rank</span>
                        </div>
                        <div id="ranking-feature-detail" class="mode-feature-detail">
                            <span class="placeholder">Click a feature to view Neuronpedia details</span>
                        </div>
                    </div>
                    <div class="export-section">
                        <button id="export-rank-json" class="btn-small" disabled>Export JSON</button>
                        <button id="export-rank-csv" class="btn-small" disabled>Export CSV</button>
                    </div>
                </div>
            </section>
        </main>

        <!-- Status Bar -->
        <footer class="status-bar">
            <span id="status-text">Ready</span>
            <span id="config-info">Loading config...</span>
        </footer>
    </div>

    <!-- Floating Steering Sidebar -->
    <aside class="steering-sidebar" id="steering-sidebar">
        <div class="sidebar-resize-handle" id="sidebar-resize-handle" title="Drag to resize"></div>
        <button class="sidebar-toggle" id="sidebar-toggle" title="Toggle Steering Panel">
            <span class="toggle-icon">&#9881;</span>
            <span class="toggle-label">Steer</span>
        </button>
        <div class="sidebar-content">
            <div class="sidebar-header">
                <h3>Steering Queue</h3>
                <button class="sidebar-close" id="sidebar-close" title="Close">×</button>
            </div>

            <div class="queue-section">
                <div class="queue-header">
                    <span class="queue-count">0 features</span>
                    <button class="btn-small btn-clear-queue" id="clear-queue-btn" title="Clear all">Clear</button>
                </div>
                <div class="steering-queue-list" id="steering-queue-list">
                    <span class="placeholder">Add features from any tab using the + button</span>
                </div>
            </div>

            <div class="sidebar-controls">
                <div class="control-group">
                    <label for="sidebar-prompt">Prompt</label>
                    <textarea id="sidebar-prompt" rows="3" placeholder="Enter prompt for steering...">Tell me a fun fact.</textarea>
                </div>
                <div class="control-row">
                    <div class="control-group">
                        <label for="sidebar-tokens">Max tokens</label>
                        <input type="number" id="sidebar-tokens" min="10" max="200" value="80" />
                    </div>
                    <div class="control-group">
                        <label for="sidebar-normalization">Post-Steering Norm</label>
                        <select id="sidebar-normalization">
                            <option value="">None</option>
                            <option value="preserve_norm" selected>Preserve Norm</option>
                            <option value="clamp">Clamp (1.5x)</option>
                        </select>
                    </div>
                    <div class="control-group checkbox-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="sidebar-unit-normalize" />
                            Unit Normalize
                        </label>
                    </div>
                    <div class="control-group checkbox-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="sidebar-show-baseline" checked />
                            Show Baseline
                        </label>
                    </div>
                </div>
                <div class="btn-row">
                    <button type="button" id="sidebar-steer-btn" class="btn-steer">
                        <span class="btn-text">Generate with Steering</span>
                        <span class="btn-loading hidden">Generating...</span>
                    </button>
                    <button type="button" id="bake-in-btn" class="btn-bake" title="Permanently apply steering to model weights">
                        Bake In
                    </button>
                </div>
            </div>

            <div class="sidebar-output" id="sidebar-output">
                <span class="placeholder">Configure steering and click generate</span>
            </div>
        </div>
    </aside>

    <!-- Bake In Confirmation Modal -->
    <div class="modal-overlay hidden" id="bake-in-modal">
        <div class="modal">
            <div class="modal-header">
                <h3>Bake In Steering Vectors</h3>
                <button class="modal-close" id="bake-in-close">×</button>
            </div>
            <div class="modal-body">
                <div class="modal-warning">
                    This will permanently modify the model weights and save to a new location.
                    The original model will not be modified.
                </div>
                <div class="form-group">
                    <label for="bake-in-path">Output Path</label>
                    <input type="text" id="bake-in-path" placeholder="Path to save modified model" />
                    <span class="form-hint">e.g., D:\models\gemma-3-4b-it-steered</span>
                </div>
                <div class="form-group">
                    <label for="bake-in-scale">Scale Factor</label>
                    <input type="number" id="bake-in-scale" min="0.1" max="10" step="0.1" value="1.0" />
                    <span class="form-hint">Multiplier for steering strength (1.0 = same as runtime steering)</span>
                </div>
                <div class="form-info" id="bake-in-features-info">
                    No features in steering queue
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" id="bake-in-cancel">Cancel</button>
                <button class="btn-primary btn-danger" id="bake-in-apply">
                    <span class="btn-text">Apply & Save Model</span>
                    <span class="btn-loading hidden">Saving...</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay hidden" id="settings-modal">
        <div class="modal">
            <div class="modal-header">
                <h3>Configuration</h3>
                <button class="modal-close" id="settings-close">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="config-model-path">Model Path</label>
                    <input type="text" id="config-model-path" placeholder="Local path or HuggingFace ID" />
                    <span class="form-hint">e.g., google/gemma-3-4b-it or D:\models\gemma-3-4b-it</span>
                </div>
                <div class="form-group">
                    <label for="config-sae-repo">SAE Repository</label>
                    <input type="text" id="config-sae-repo" placeholder="HuggingFace SAE repo" />
                    <span class="form-hint">e.g., google/gemma-scope-2-4b-it</span>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="config-sae-width">SAE Width</label>
                        <select id="config-sae-width">
                            <option value="16k">16k</option>
                            <option value="65k">65k</option>
                            <option value="262k" selected>262k</option>
                            <option value="1M">1M</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="config-sae-l0">SAE L0</label>
                        <select id="config-sae-l0">
                            <option value="small">small</option>
                            <option value="medium">medium</option>
                            <option value="large">large</option>
                        </select>
                    </div>
                </div>
                <div class="form-info" id="config-layers-info">
                    Available layers will be shown after loading
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" id="settings-cancel">Cancel</button>
                <button class="btn-primary" id="settings-apply">
                    <span class="btn-text">Apply & Reload</span>
                    <span class="btn-loading hidden">Applying...</span>
                </button>
            </div>
        </div>
    </div>

    <script src="/static/app.js"></script>
</body>
</html>
