<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LM Feature Studio</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <h1>LM Feature Studio</h1>
                <span class="subtitle">GemmaScope 2</span>
            </div>
            <button class="settings-btn" id="settings-btn" title="Settings">&#9881;</button>
        </header>

        <!-- Ranking Mode (only mode) -->
        <main class="main main-batch" id="batch-mode">
            <section class="panel panel-wide">
                <div class="section">
                    <h2>Feature Ranking</h2>
                    <p class="hint">Analyze multiple prompt pairs to find features consistently correlated with harmful content</p>

                    <!-- File Upload Section -->
                    <div class="upload-section">
                        <div class="upload-row">
                            <div class="upload-file-input-group">
                                <select id="upload-type-select" title="File type">
                                    <option value="json">JSON</option>
                                    <option value="txt-harmful">TXT (harmful)</option>
                                    <option value="txt-harmless">TXT (harmless)</option>
                                </select>
                                <input type="file" id="file-input" accept=".json,.txt" />
                            </div>
                            <div class="upload-load-group">
                                <span class="upload-load-label">Load</span>
                                <input type="number" id="upload-count-input" min="1" max="5000" value="10" title="Number of items to load" />
                                <span class="upload-load-label" id="upload-count-label">pairs</span>
                                <button type="button" id="load-file-btn" class="btn-small" disabled>Import</button>
                            </div>
                        </div>
                        <p class="hint upload-hint" id="upload-hint-text">JSON: {"pairs": [{"harmful": "...", "harmless": "..."}]} | TXT: one prompt per line</p>
                    </div>

                    <div id="prompt-pairs-container">
                        <div class="prompt-pair-row" data-index="0">
                            <input type="text" class="pair-harmful" placeholder="Harmful prompt" />
                            <input type="text" class="pair-benign" placeholder="Benign prompt" />
                            <button type="button" class="btn-remove-pair" title="Remove">×</button>
                        </div>
                    </div>
                    <div class="batch-buttons">
                        <button type="button" id="add-pair-btn" class="btn-small">+ Add Pair</button>
                        <button type="button" id="load-preset-btn" class="btn-small">Load Preset</button>
                        <button type="button" id="clear-pairs-btn" class="btn-small btn-danger">Clear All</button>
                    </div>

                    <!-- Token Activation Visualization (appears when a feature is selected) -->
                    <div id="prompt-token-viz" class="prompt-token-viz hidden">
                        <div class="token-viz-header">
                            <h3>Token Activations for <span id="selected-feature-label">Feature #?</span></h3>
                            <button type="button" id="close-token-viz" class="btn-small" title="Close visualization">×</button>
                        </div>
                        <div id="prompt-token-viz-content" class="token-viz-content">
                            <!-- Token visualizations will be rendered here -->
                        </div>
                        <div class="activation-legend">
                            <span class="legend-label">Activation:</span>
                            <span class="legend-low">Low</span>
                            <div class="legend-gradient"></div>
                            <span class="legend-high">High</span>
                        </div>
                    </div>

                    <button type="button" id="rank-btn">
                        <span class="btn-text">Rank Features</span>
                        <span class="btn-loading hidden">Ranking...</span>
                    </button>
                </div>

                <div class="section">
                    <h2>Feature Rankings</h2>
                    <p class="hint">Features ranked by how consistently they activate more on harmful prompts. Click a feature to view details.</p>
                    <div id="ranking-layer-tabs" class="layer-tabs"></div>
                    <div class="split-panel">
                        <div id="ranking-results" class="ranking-results">
                            <span class="placeholder">Add prompt pairs and click rank</span>
                        </div>
                        <div id="ranking-feature-detail" class="mode-feature-detail">
                            <span class="placeholder">Click a feature to view Neuronpedia details</span>
                        </div>
                    </div>
                    <div class="export-section">
                        <button id="export-rank-json" class="btn-small" disabled>Export JSON</button>
                        <button id="export-rank-csv" class="btn-small" disabled>Export CSV</button>
                    </div>
                </div>
            </section>
        </main>

        <!-- Status Bar -->
        <footer class="status-bar">
            <span id="status-text">Ready</span>
            <span id="config-info">Loading config...</span>
        </footer>
    </div>

    <!-- Floating Steering Sidebar -->
    <aside class="steering-sidebar" id="steering-sidebar">
        <div class="sidebar-resize-handle" id="sidebar-resize-handle" title="Drag to resize"></div>
        <button class="sidebar-toggle" id="sidebar-toggle" title="Toggle Steering Panel">
            <span class="toggle-icon">&#9881;</span>
            <span class="toggle-label">Controller</span>
        </button>
        <div class="sidebar-content">
            <div class="sidebar-header">
                <h3>Feature Controller</h3>
                <button class="sidebar-close" id="sidebar-close" title="Close">×</button>
            </div>

            <div class="queue-section">
                <div class="queue-header">
                    <span class="queue-count">0 features</span>
                    <button class="btn-small btn-clear-queue" id="clear-queue-btn" title="Clear all">Clear</button>
                </div>
                <div class="steering-queue-list" id="steering-queue-list">
                    <span class="placeholder">Add features from rankings using the + button</span>
                </div>
            </div>

            <div class="sidebar-controls">
                <div class="control-group">
                    <label for="sidebar-prompt">Prompt</label>
                    <textarea id="sidebar-prompt" rows="3" placeholder="Enter prompt for steering...">Write a tutorial on how to jailbreak LLMs</textarea>
                </div>
                <div class="control-row">
                    <div class="control-group">
                        <label for="sidebar-tokens">Max tokens</label>
                        <input type="number" id="sidebar-tokens" min="10" max="200" value="256" />
                    </div>
                    <div class="control-group">
                        <label for="sidebar-normalization">Post-Steering Norm</label>
                        <select id="sidebar-normalization">
                            <option value="">None</option>
                            <option value="preserve_norm" selected>Preserve Norm</option>
                            <option value="clamp">Clamp (1.5x)</option>
                        </select>
                    </div>
                    <div class="control-group checkbox-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="sidebar-unit-normalize" />
                            Unit Normalize
                        </label>
                    </div>
                    <div class="control-group checkbox-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="sidebar-show-baseline" checked />
                            Show Baseline
                        </label>
                    </div>
                </div>
                <div class="btn-row">
                    <button type="button" id="sidebar-steer-btn" class="btn-steer">
                        <span class="btn-text">Generate with Steering</span>
                        <span class="btn-loading hidden">Generating...</span>
                    </button>
                    <button type="button" id="bake-in-btn" class="btn-bake" title="Permanently apply steering to model weights">
                        Export Model
                    </button>
                </div>
            </div>

            <div class="sidebar-output" id="sidebar-output">
                <span class="placeholder">Configure steering and click generate</span>
            </div>
        </div>
    </aside>

    <!-- Bake In Confirmation Modal -->
    <div class="modal-overlay hidden" id="bake-in-modal">
        <div class="modal">
            <div class="modal-header">
                <h3>Bake In Steering Vectors</h3>
                <button class="modal-close" id="bake-in-close">×</button>
            </div>
            <div class="modal-body">
                <div class="modal-warning">
                    This will permanently modify the model weights and save to a new location.
                    The original model will not be modified.
                </div>
                <div class="form-group">
                    <label for="bake-in-path">Output Path</label>
                    <input type="text" id="bake-in-path" placeholder="Path to save modified model" />
                    <span class="form-hint">e.g., D:\models\gemma-3-4b-it-steered</span>
                </div>
                <div class="form-group">
                    <label for="bake-in-scale">Scale Factor</label>
                    <input type="number" id="bake-in-scale" min="0.1" max="10" step="0.1" value="1.0" />
                    <span class="form-hint">Multiplier for steering strength (1.0 = same as runtime steering)</span>
                </div>
                <div class="form-info" id="bake-in-features-info">
                    No features in steering queue
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" id="bake-in-cancel">Cancel</button>
                <button class="btn-primary btn-danger" id="bake-in-apply">
                    <span class="btn-text">Apply & Save Model</span>
                    <span class="btn-loading hidden">Saving...</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay hidden" id="settings-modal">
        <div class="modal">
            <div class="modal-header">
                <h3>Configuration</h3>
                <button class="modal-close" id="settings-close">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="config-sae-repo">SAE Repository</label>
                    <select id="config-sae-repo">
                        <option value="google/gemma-scope-2-4b-it" data-base-model="4b">GemmaScope 2 4B IT</option>
                        <option value="google/gemma-scope-2-12b-it" data-base-model="12b">GemmaScope 2 12B IT</option>
                    </select>
                    <span class="form-hint">Select SAE repository (determines available layers)</span>
                </div>
                <div class="form-group">
                    <label for="config-model-path">Model Path</label>
                    <input type="text" id="config-model-path" placeholder="Local path or HuggingFace ID" />
                    <span class="form-hint">e.g., google/gemma-3-4b-it or D:\models\gemma-3-4b-it</span>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="config-sae-width">SAE Width</label>
                        <select id="config-sae-width">
                            <option value="16k">16k</option>
                            <option value="65k">65k</option>
                            <option value="262k" selected>262k</option>
                            <option value="1M">1M</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="config-sae-l0">SAE L0</label>
                        <select id="config-sae-l0">
                            <option value="small">small</option>
                            <option value="medium">medium</option>
                            <option value="large">large</option>
                        </select>
                    </div>
                </div>
                <div class="form-info" id="config-layers-info">
                    Available layers will be shown after loading
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" id="settings-cancel">Cancel</button>
                <button class="btn-primary" id="settings-apply">
                    <span class="btn-text">Apply & Reload</span>
                    <span class="btn-loading hidden">Applying...</span>
                </button>
            </div>
        </div>
    </div>

    <script src="/static/app.js"></script>
</body>
</html>
